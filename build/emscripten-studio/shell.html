<!doctype html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Suika2 Studio WASM</title>
  <meta name="viewport" content="width=device-width, user-scalable=no, maximum-scale=1, initial-scale=1">
  <style>
    html, body {
        padding 0;
        margin: 0;
        width: 100%;
        height: 100%;
        position: fixed;
    }
		div.grid-holder {
				display: grid;
				grid-template-rows: 30px calc(100svh - 40% - 30px) 40%;
				grid-template-columns: 100%;
				width: 100%;
				height: 100%;
		}
		div.grid-row1 {
				grid-row: 1;
				grid-column: 1;
				width: 100%;
				height: 100%;
		}
		div.grid-row2 {
				grid-row: 2;
				grid-column: 1;
				width: 100%;
				height: 100%;
		}
		div.grid-row3 {
				grid-row: 3;
				grid-column: 1;
				width: 100%;
				height: 100%;
		}
    div.canvasHolder {
        border: 0px;
        margin: auto;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
    }
    canvas.emscripten {
        padding-right: 0;
        margin-left: auto;
        margin-right: auto;
        display: block;
        display: table-cell;
        vertical-align: middle;
        background-color: black;
        outline: none;
        max-width: 100svw;
        max-height: 100svh;
        -webkit-tap-highlight-color: rgba(255, 255, 255, 0);
    }
    #editor { 
        width: 100%;
        height: 100%;
    }
		.execLine {
        background: rgba(255, 200, 200, 0.5);
    }
  </style>
	<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.31.1/src-min-noconflict/ace.min.js"></script>
	<link href="https://cdn.jsdelivr.net/npm/ace-builds@1.31.1/css/ace.min.css" rel="stylesheet">
</head>
<body style="padding: 0; margin: 0;">

	<div class="grid-holder">
		<div class="grid-row1">
			<button id="btnOpenLocalProject">ローカル編集</button>
			<button id="btnOpenSampleProject">ダウンロード編集</button>
			<button id="btnContinue" style="display: none;">続ける</button>
			<button id="btnNext" style="display: none;">次へ</button>
			<button id="btnStop" style="display: none;">停止</button>
			<button id="btnMove" style="display: none;">行移動</button>
			<button id="btnOpen" style="display: none;">開く</button>
			<span id="fileName"></span>
			<span id="runningStatus"></span>
    </div>
		<div class="grid-row2">
			<div id="editor">スクリプトがここに表示されます。</div>
		</div>
		<div class="grid-row3">
			<div id="canvasHolder" class="canvasHolder">
				<video id="video" style="width: 100%; display: none;"></video>  
				<canvas id="canvas" class="emscripten" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>
			</div>
		</div>
	</div>

  <!-- Code for Emscripten Base -->
  <script type='text/javascript'>
    var Module = {
      preRun: [],
      postRun: [],
      print: (function(text) {
					if(typeof text !== 'undefined')
							window.alert(text);
      })(),
			printErr: (function(text) {
					if(typeof text !== 'undefined')
							window.alert(text);
			})(),
      canvas: (function() {
        var canvas = document.getElementById('canvas');
        canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);
        return canvas;
      })(),
      totalDependencies: 0,
      monitorRunDependencies: function(left) {
        this.totalDependencies = Math.max(this.totalDependencies, left);
      }
    };
    window.onerror = function() {
      window.alert('Exception thrown, see JavaScript console');
    };
  </script>

  <!-- Code for Suika2 Main Engine -->
  <script type="text/javascript">
		function resizeWindow(event) {
				canvas = document.getElementById('canvas');
				aspect = canvas.width / canvas.height;
				holder = document.getElementById('canvasHolder');
				w = holder.offsetWidth;
				h = holder.offsetWidth / aspect;
				if (h > holder.offsetHeight) {
						h = holder.offsetHeight;
						w = holder.offsetHeight * aspect;
				}
				canvas.style.width = w + 'px';
				canvas.style.height = h + 'px';
				canvas.focus();
    }
    window.addEventListener('resize', resizeWindow);

		function changeVisibility() {
				if (document.visibilityState === 'visible') {
						Module.ccall('setVisible', null, null, null);
						document.getElementById('canvas').focus();
				} else if (document.visibilityState === 'hidden') {
						Module.ccall('setHidden', null, null, null);
				}
	  }
		document.addEventListener('visibilitychange', changeVisibility);
  </script>

  <!-- Code for Suika2 Studio -->
  <script type="text/javascript">
		// File System API
		var dirHandle = null;

		// "プロジェクトを開く"がクリックされたときのハンドラ
		document.getElementById('btnOpenLocalProject').onclick = async () => {
				// ユーザ選択のディレクトリを開く
        try {
            dirHandle = await window.showDirectoryPicker({mode: "readwrite"});
            if (typeof dirHandle === 'undefined') {
                alert('ディレクトリを開けません。');
                return;
            }
        } catch (e) {
            alert('ブラウザがファイルの表示を許可していません。');
            return;
        }

				// ボタンを消す
        document.getElementById('btnOpenLocalProject').style.display = 'none';
        document.getElementById('btnOpenSampleProject').style.display = 'none';

		    // ボタンを表示する
        document.getElementById('btnContinue').style.display = 'inline';
        document.getElementById('btnNext').style.display = 'inline';
        document.getElementById('btnStop').style.display = 'inline';
        document.getElementById('btnMove').style.display = 'inline';

		    // 実行を開始する
        document.getElementById('runningStatus').innerHTML = 'オープン';
				Module.ccall('onLoadProject', null, null, null);
		};

		// "ダウンロードして開く"がクリックされたときのハンドラ
		document.getElementById('btnOpenSampleProject').onclick = async () => {
				// OPFSのディレクトリを開く
				dirHandle = await navigator.storage.getDirectory();
				if (typeof dirHandle === 'undefined')
						return;

				// ボタンを消す
        document.getElementById('btnOpenLocalProject').style.display = 'none';
        document.getElementById('btnOpenSampleProject').style.display = 'none';

		    // プロジェクトのファイルをダウンロードする
				fileList = await downloadProjectFileList();
				for (let file of fileList.split(/\n/)) {
		        if (file !== '') {
								if (! await downloadAndSaveBinary(file)) {
                    document.getElementById('runningStatus').innerHTML = 'ダウンロード失敗';
                    return;
                }
            }
		    }

		    // ボタンを表示する
        document.getElementById('btnContinue').style.display = 'inline';
        document.getElementById('btnNext').style.display = 'inline';
        document.getElementById('btnStop').style.display = 'inline';
        document.getElementById('btnMove').style.display = 'inline';

		    // 実行を開始する
        document.getElementById('runningStatus').innerHTML = 'Opened';
        Module.ccall('onLoadProject', null, null, null);
    };

		// "続ける"がクリックされたときのハンドラ
		document.getElementById('btnContinue').onclick = () => {
				// emedit.cのonClickContinue()を呼び出す
				Module.ccall('onClickContinue', null, null, null);
		};

		// "次へ"がクリックされたときのハンドラ
		document.getElementById('btnNext').onclick = () => {
				// emedit.cのonClickNext()を呼び出す
				Module.ccall('onClickNext', null, null, null);
		};

		// "停止"がクリックされたときのハンドラ
		document.getElementById('btnStop').onclick = () => {
				// emedit.cのonClickStop()を呼び出す
				Module.ccall('onClickStop', null, null, null);
		};

		// "行移動"がクリックされたときのハンドラ
		document.getElementById('btnMove').onclick = () => {
				// emedit.cのonCtrlReturn()を呼び出す
				Module.ccall('onCtrlReturn', null, null, null);
		};

		// プロジェクトファイルの一覧をダウンロードする
		async function downloadProjectFileList() {
				document.getElementById('runningStatus').innerHTML = 'Downloading files.txt...';
				const text = await new Promise((resolve) => {
						const xhr = new XMLHttpRequest();
						xhr.open('GET', 'https://suika2.com/vls/template/files.txt', true);
						xhr.onreadystatechange = async function(resolv, reject) {
								if (xhr.readyState == 4 && xhr.status == 200)
										resolve(xhr.responseText);
						}
						xhr.send();
				});
        return text;
		}

		// プロジェクト内のファイルを1つダウンロードして保存する
		async function downloadAndSaveBinary(fileName) {
				document.getElementById('runningStatus').innerHTML = 'Downloading ' + fileName + '...';
				const blob = await new Promise((resolve) => {
						const xhr = new XMLHttpRequest();
						xhr.open('GET', 'https://suika2.com/vls/template/' + fileName, true);
						xhr.responseType = 'arraybuffer';
						xhr.onreadystatechange = async function(resolv, reject) {
								if (xhr.readyState == 4 && xhr.status == 200)
										resolve(new Blob([xhr.response], {text: 'application/octet-stream'}));
						}
						xhr.send();
				});
				const dir = fileName.split('/')[0];
				const file = fileName.split('/')[1];
		    try {
		        const subdirHandle = await dirHandle.getDirectoryHandle(dir, { create: true });
		        const fileHandle = await subdirHandle.getFileHandle(file, { create: true });
            const writableStream = await fileHandle.createWritable();
            await writableStream.write({ type: "truncate", size: 0 });
            await writableStream.write(blob);
            await writableStream.close();
        } catch (e) {
           alert('ブラウザがファイルの保存を許可していません。');
           return false;
        }
        return true;
		}
	</script>

  <!-- Code for Ace Editor -->
	<script>
    // エディタ
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
		editor.resize();
    //editor.session.setMode("ace/mode/javascript");

		// キーハンドラ
		document.getElementById('editor').addEventListener('keydown', (e) => {
      const range = editor.getSelectionRange();
			if ((e.ctrlKey && (e.key == 'z' || e.key == 'x' || e.key == 'c' || e.key == 'v' || e.key == 'y')) ||
			    (e.metaKey && (e.key == 'z' || e.key == 'x' || e.key == 'c' || e.key == 'v' || e.key == 'y')) ||
          (range.start != range.end) ||
			    (!e.ctrlKey && e.key == 'Enter') ||
			    (!e.ctrlKey && e.key == 'Backspace') ||
			    (!e.ctrlKey && e.key == 'Delete'))
        Module.ccall('onRangeChange', null, null, null);
			if (e.ctrlKey && e.key == 'Enter')
        Module.ccall('onCtrlReturn', null, null, null);
		});

    // 変更ハンドラ
		editor.session.on('change', () => {
        Module.ccall('onRangeChange', null, null, null);
		});

		// キーボード表示時にCanvasを隠す
    window.visualViewport.addEventListener('resize', () => {
			const MIN_KEYBOARD_HEIGHT = 300;
			const isMobile = window.innerWidth < 768;
			const isKeyboard = isMobile && window.screen.height - MIN_KEYBOARD_HEIGHT > window.visualViewport.height;
      if (isKeyboard)
          document.getElementById('canvas').style.display = 'none';
      else
          document.getElementById('canvas').style.display = 'block';
    });

		// エディタのコンテンツを設定するときに一時変数
		var editorText = "";
	</script>

	<!-- Placeholder for Emscripten generated code-->
  {{{ SCRIPT }}}

</body>
</html>
